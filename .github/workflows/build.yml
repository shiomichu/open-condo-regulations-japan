name: Build PDF

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Install WeasyPrint
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-cffi libcairo2 libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf2.0-0 libffi-dev shared-mime-info
          pip3 install weasyprint

      - name: Prepare cover page
        run: |
          cp cover.html cover_work.html
          if [ "${{ matrix.minpaku }}" = "true" ]; then
            sed -i "s/{{TITLE}}/民泊禁止版/g" cover_work.html
          else
            sed -i "s/{{TITLE}}/民泊許可版/g" cover_work.html
          fi

      - name: Convert to HTML (single file)
        run: |
          pandoc \
            --include-before-body=cover_work.html \
            --metadata title="管理規約" \
            --template="$(pwd)/template.html" \
            --standalone \
            dist/output.md \
            -o temp.html

      - name: Convert to PDF (WeasyPrint)
        run: |
          if [ "${{ matrix.minpaku }}" = "true" ]; then
            OUT="管理規約_民泊禁止版.pdf"
          else
            OUT="管理規約_民泊許可版.pdf"
          fi

          weasyprint temp.html "dist/$OUT"